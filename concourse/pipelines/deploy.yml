---
display:
  background_image: ((background_image))

definitions:
- &bootstrap-trigger
  get: bootstrap-event
  trigger: true
  passed: [run-terraform]
  params:
   skip_download: true

resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest # TODO - don't use latest (once we've worked out a policy for third party images)
      username: ((docker_hub_username))
      password: ((docker_hub_authtoken))

  - name: s3
    type: docker-image
    source:
      repository: governmentpaas/s3-resource
      tag: latest # TODO - don't use latest (once we've worked out a policy for third party images)

  # This resource uses an instance profile to access buckets in our AWS accounts
  - name: s3-iam
    type: registry-image
    source:
      repository: govuk/s3-resource
      tag: 0.0.0v6

  - name: registry-image
    type: docker-image
    source:
      repository: govuk/registry-image
      tag: f0.0.1
      username: ((docker_hub_username))
      password: ((docker_hub_authtoken))

  - name: cron-resource
    type: docker-image
    source:
      repository: cftoolsmiths/cron-resource
      tag: latest
      username: ((docker_hub_username))
      password: ((docker_hub_authtoken))

resources:
  - &git-repo
    icon: github
    name: govuk-infrastructure
    source: &govuk-infrastructure-source
      branch: ((govuk_infrastructure_branch))
      uri: https://github.com/alphagov/govuk-infrastructure
    type: git

  - <<: *git-repo
    name: content-schemas
    source:
      branch: main
      uri: https://github.com/alphagov/govuk-content-schemas

  - name: publishing-api-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/publishing-api.json
      initial_version: "0"

  - <<: *git-repo
    name: govuk-infrastructure-concourse-tasks
    icon: concourse-ci
    source:
      <<: *govuk-infrastructure-source
      paths: [ concourse/tasks, lib/signon, lib/tasks/secretsmanager.rake, lib/tasks/bootstrap.rake ]

  - name: smokey-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/smokey.json
      initial_version: "0"

  - name: deploy-slack-channel
    type: slack-notification
    icon: bell-ring
    source:
      url: https://hooks.slack.com/services/((deploy_apps_slack_webhook))
      disable: ((disable_slack_channel_alerts))

  - name: govuk-terraform-outputs
    type: s3
    icon: file
    # NOTE: this bucket is created for us by Big Concourse
    # https://reliability-engineering.cloudapps.digital/continuous-deployment.html#services
    # It's in AWS' London region (eu-west-2)
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/govuk-terraform-outputs.json

  - name: secret_key_bases-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/secret_key_bases.json
      initial_version: "0"

  - name: content-store-terraform-outputs
    type: s3
    icon: file
    # NOTE: this bucket is created for us by Big Concourse
    # https://reliability-engineering.cloudapps.digital/continuous-deployment.html#services
    # It's in AWS' London region (eu-west-2)
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/content-store.json
      initial_version: "0"

  - name: frontend-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/frontend.json
      initial_version: "0"

  - name: publisher-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/publisher.json
      initial_version: "0"

  - name: signon-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/signon.json
      initial_version: "0"

  - name: static-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/static.json
      initial_version: "0"

  - name: router-api-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/router-api.json
      initial_version: "0"

  - name: router-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/router.json
      initial_version: "0"

  - name: authenticating-proxy-terraform-outputs
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/authenticating-proxy.json
      initial_version: "0"

  # This S3 bucket resource triggers a bootstrap event, which eventually
  # triggers all jobs in the pipeline necessary to spin up a namespace.
  - name: bootstrap-event
    type: s3
    icon: file
    source:
      bucket: ((readonly_private_bucket_name))
      region_name: eu-west-2
      versioned_file: ((workspace))/event.json
      initial_version: "0"

  - &deploy-event-trigger
    name: frontend-deploy-event-trigger
    type: s3-iam
    icon: file
    source: &deploy-event-trigger-source
      aws_role_arn: ((concourse_deployer_role_arn))
      bucket: deploy-event-((govuk_environment))-((workspace))
      region_name: eu-west-1
      private: true
      skip_download: true
      regexp: frontend/(.*).json
      initial_path: frontend/0.json

  - <<: *deploy-event-trigger
    name: content-store-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: content-store/(.*).json
      initial_path: content-store/0.json

  - <<: *deploy-event-trigger
    name: draft-content-store-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: draft-content-store/(.*).json
      initial_path: draft-content-store/0.json

  - <<: *deploy-event-trigger
    name: draft-frontend-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: draft-frontend/(.*).json
      initial_path: draft-frontend/0.json

  - <<: *deploy-event-trigger
    name: publisher-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: publisher/(.*).json
      initial_path: publisher/0.json

  - <<: *deploy-event-trigger
    name: publishing-api-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: publishing-api/(.*).json
      initial_path: publishing-api/0.json

  - <<: *deploy-event-trigger
    name: router-api-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: router-api/(.*).json
      initial_path: router-api/0.json

  - <<: *deploy-event-trigger
    name: draft-router-api-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: draft-router-api/(.*).json
      initial_path: draft-router-api/0.json

  - <<: *deploy-event-trigger
    name: router-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: router/(.*).json
      initial_path: router/0.json

  - <<: *deploy-event-trigger
    name: static-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: static/(.*).json
      initial_path: static/0.json

  - <<: *deploy-event-trigger
    name: authenticating-proxy-deploy-event-trigger
    source:
      <<: *deploy-event-trigger-source
      regexp: authenticating-proxy/(.*).json
      initial_path: authenticating-proxy/0.json

  - &registry-image
    name: frontend-image
    type: registry-image
    icon: docker
    source: &registry-source
      repository: frontend
      aws_region: eu-west-1
      aws_ecr_registry_id: ((ecr_registry_id))
      aws_ec2_credentials: true
      variant: release
      aws_role_arns:
        - ((concourse_deployer_role_arn))
        - ((concourse_ecr_role_arn))

  - <<: *registry-image
    name: static-image
    source:
      <<: *registry-source
      repository: static

  - <<: *registry-image
    name: publisher-image
    source:
      <<: *registry-source
      repository: publisher

  - <<: *registry-image
    name: publishing-api-image
    source:
      <<: *registry-source
      repository: publishing-api

  - <<: *registry-image
    name: content-store-image
    source:
      <<: *registry-source
      repository: content-store

  - <<: *registry-image
    name: router-image
    source:
      <<: *registry-source
      repository: router

  - <<: *registry-image
    name: router-api-image
    source:
      <<: *registry-source
      repository: router-api

  - <<: *registry-image
    name: signon-image
    source:
      <<: *registry-source
      repository: signon

  - <<: *registry-image
    name: authenticating-proxy-image
    source:
      <<: *registry-source
      repository: authenticating-proxy

  - <<: *registry-image
    name: smokey-image
    source:
      <<: *registry-source
      repository: smokey

  - name: everyday-at-11pm
    type: cron-resource
    source:
      expression: "0 23 * * 1-5"
      location: "Europe/London"

  - name: everyday-at-6am
    type: cron-resource
    source:
      expression: "0 06 * * 1-5"
      location: "Europe/London"
      fire_immediately: true

  - name: every-10-minutes-in-daytime
    type: cron-resource
    source:
      expression: "*/10 8-20 * * 1-5"
      location: "Europe/London"
      fire_immediately: true

groups:
  - name: all
    jobs:
      - update-pipeline
      - create-infrastructure
      - run-terraform
      - deploy-content-store
      - deploy-content-schemas
      - deploy-frontend
      - destroy-infrastructure
      - deploy-publisher
      - deploy-publishing-api
      - deploy-router
      - deploy-router-api
      - deploy-signon
      - deploy-smokey
      - deploy-static
      - deploy-authenticating-proxy
      - all-smoke-tests
      - smoke-test-frontend
      - smoke-test-publisher
      - smoke-test-signon
      - autogenerate-secrets

  - name: terraform
    jobs:
      - destroy-infrastructure
      - create-infrastructure
      - run-terraform

  - name: admin
    jobs:
      - update-pipeline

  - name: content-store
    jobs:
      - deploy-signon
      - deploy-router-api
      - deploy-content-store

  - name: frontend
    jobs:
      - deploy-signon
      - deploy-static
      - deploy-content-store
      - deploy-frontend
      - smoke-test-frontend

  - name: publisher
    jobs:
      - deploy-signon
      - deploy-static
      - deploy-content-store
      - deploy-frontend
      - deploy-publisher
      - smoke-test-publisher

  - name: publishing-api
    jobs:
      - deploy-publishing-api
      - deploy-content-schemas
      - deploy-signon
      - deploy-content-store

  - name: router
    jobs:
      - deploy-router

  - name: router-api
    jobs:
      - deploy-signon
      - deploy-router-api

  - name: signon
    jobs:
      - autogenerate-secrets
      - deploy-signon
      - smoke-test-signon

  - name: smokey
    jobs:
      - deploy-smokey
      - all-smoke-tests
      - smoke-test-frontend
      - smoke-test-publisher
      - smoke-test-signon

  - name: static
    jobs:
      - deploy-static

  - name: authenticating-proxy
    jobs:
      - deploy-signon
      - deploy-authenticating-proxy

jobs:
  # create-infrastructure triggers the creation of all resources in a GOV.UK
  # namespace by placing a file in an S3 bucket.
  # TODO: Do we need to remove the object when we destroy infra?
  - name: create-infrastructure
    serial: true
    plan:
    - try:
        get: everyday-at-6am
        trigger: true
    - task: create-bootstrap-trigger
      config:
        outputs:
        - name: bootstrap-event
        params:
          WORKSPACE: ((workspace))
        platform: linux
        image_resource:
          type: docker-image
          source:
            # TODO: Use ECR
            repository: govuk/infra-concourse-task
            tag: 0.0.2
            username: ((docker_hub_username))
            password: ((docker_hub_authtoken))
        run:
          path: sh
          args:
            - '-c'
            - |
              set -eu
              echo "{\"date\":\"$(date '+%Y-%m-%d %H:%M:%S')\"}" > bootstrap-event/event.json
    - put: bootstrap-event
      params:
        file: bootstrap-event/event.json

  - name: destroy-infrastructure
    plan:
    - get: everyday-at-11pm
      trigger: true
    - get: govuk-infrastructure
      trigger: false
    - task: destroy-terraform
      attempts: 3
      config:
        inputs:
        - name: govuk-infrastructure
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          AWS_REGION: eu-west-1
          WORKSPACE: ((workspace))
          GOVUK_ENVIRONMENT: ((govuk_environment))
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: hashicorp/terraform
            tag: 1.0.0
            username: ((docker_hub_username))
            password: ((docker_hub_authtoken))
        run:
          path: sh
          args:
            - '-c'
            - |
              set -eu

              root_dir=$(pwd)

              cd govuk-infrastructure/terraform/deployments/govuk-publishing-platform

              terraform init -backend-config "./${GOVUK_ENVIRONMENT}.backend" -backend-config "role_arn=$ASSUME_ROLE_ARN"

              terraform workspace select "$WORKSPACE"

              terraform destroy  \
              -var "assume_role_arn=$ASSUME_ROLE_ARN" \
              -var-file ../variables/common.tfvars \
              -var-file "../variables/${GOVUK_ENVIRONMENT}/common.tfvars" \
              -var-file "../variables/${GOVUK_ENVIRONMENT}/infrastructure.tfvars" \
              -auto-approve

  - name: update-pipeline
    plan:
    - get: govuk-infrastructure
      trigger: true
    - file: govuk-infrastructure/concourse/pipelines/deploy.yml
      set_pipeline: self
      var_files:
        - govuk-infrastructure/concourse/parameters/((govuk_environment))/deploy.yml

  - name: run-terraform
    serial: true
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        passed:
        - update-pipeline
        trigger: true
      - get: bootstrap-event
        trigger: true
        passed: [create-infrastructure]
      - get: content-store-terraform-outputs
      - get: publisher-terraform-outputs
      - get: publishing-api-terraform-outputs
      - get: signon-terraform-outputs
      - get: smokey-terraform-outputs
      - get: static-terraform-outputs
      - get: router-api-terraform-outputs
      - get: router-terraform-outputs
      - get: frontend-terraform-outputs
      - get: authenticating-proxy-terraform-outputs
      - get: secret_key_bases-terraform-outputs
    - task: terraform-apply
      config:
        inputs:
        - name: govuk-infrastructure
        - name: content-store-terraform-outputs
          path: old-content-store-terraform-outputs
          optional: true
        - name: frontend-terraform-outputs
          path: old-frontend-terraform-outputs
          optional: true
        - name: secret_key_bases-terraform-outputs
          path: old-secret_key_bases-terraform-outputs
          optional: true
        - name: publisher-terraform-outputs
          path: old-publisher-terraform-outputs
          optional: true
        - name: publishing-api-terraform-outputs
          path: old-publishing-api-terraform-outputs
          optional: true
        - name: signon-terraform-outputs
          path: old-signon-terraform-outputs
          optional: true
        - name: smokey-terraform-outputs
          path: old-smokey-terraform-outputs
          optional: true
        - name: static-terraform-outputs
          path: old-static-terraform-outputs
          optional: true
        - name: router-api-terraform-outputs
          path: old-router-api-terraform-outputs
          optional: true
        - name: router-terraform-outputs
          path: old-router-terraform-outputs
          optional: true
        - name: authenticating-proxy-terraform-outputs
          path: old-authenticating-proxy-terraform-outputs
        outputs:
        - name: govuk-terraform-outputs
        - name: content-store-terraform-outputs
          path: new-content-store-terraform-outputs
        - name: frontend-terraform-outputs
          path: new-frontend-terraform-outputs
        - name: publisher-terraform-outputs
          path: new-publisher-terraform-outputs
        - name: publishing-api-terraform-outputs
          path: new-publishing-api-terraform-outputs
        - name: signon-terraform-outputs
          path: new-signon-terraform-outputs
        - name: smokey-terraform-outputs
          path: new-smokey-terraform-outputs
        - name: static-terraform-outputs
          path: new-static-terraform-outputs
        - name: router-api-terraform-outputs
          path: new-router-api-terraform-outputs
        - name: router-terraform-outputs
          path: new-router-terraform-outputs
        - name: secret_key_bases-terraform-outputs
          path: new-secret_key_bases-terraform-outputs
        - name: authenticating-proxy-terraform-outputs
          path: new-authenticating-proxy-terraform-outputs
          optional: true
        params:
          AWS_REGION: eu-west-1
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          WORKSPACE: ((workspace))
          GOVUK_ENVIRONMENT: ((govuk_environment))
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: hashicorp/terraform
            tag: 1.0.0
            username: ((docker_hub_username))
            password: ((docker_hub_authtoken))
        run:
          path: sh
          args:
          - '-c'
          - |
            set -eu

            root_dir=$(pwd)

            cd govuk-infrastructure/terraform/deployments/govuk-publishing-platform

            terraform init -backend-config "./${GOVUK_ENVIRONMENT}.backend" -backend-config "role_arn=$ASSUME_ROLE_ARN"

            terraform workspace select "$WORKSPACE" || terraform workspace new "$WORKSPACE"

            terraform apply \
              -var "assume_role_arn=$ASSUME_ROLE_ARN" \
              -var-file ../variables/common.tfvars \
              -var-file "../variables/${GOVUK_ENVIRONMENT}/common.tfvars" \
              -var-file "../variables/${GOVUK_ENVIRONMENT}/infrastructure.tfvars" \
              -auto-approve

            terraform output -json > "$root_dir/govuk-terraform-outputs/govuk-terraform-outputs.json"

            update_terraform_outputs() {
              output="$1"
              terraform output -json "${output}" > "$root_dir/new-${output}-terraform-outputs/${output}.json"

              if cmp \
                "$root_dir/old-${output}-terraform-outputs/${output}.json" \
                "$root_dir/new-${output}-terraform-outputs/${output}.json"
              then
                # If the new terraform outputs are the same as the old ones
                # delete them to avoid unnecessarily creating a new resource version
                rm "$root_dir/new-${output}-terraform-outputs/${output}.json"
              fi
            }

            update_terraform_outputs content-store
            update_terraform_outputs frontend
            update_terraform_outputs publisher
            update_terraform_outputs publishing-api
            update_terraform_outputs signon
            update_terraform_outputs smokey
            update_terraform_outputs static
            update_terraform_outputs router-api
            update_terraform_outputs router
            update_terraform_outputs authenticating-proxy
            update_terraform_outputs secret_key_bases

    - in_parallel:
      - put: govuk-terraform-outputs
        params:
          file: govuk-terraform-outputs/govuk-terraform-outputs.json
      - try:
          put: secret_key_bases-terraform-outputs
          params:
            file: secret_key_bases-terraform-outputs/secret_key_bases.json
      - try:
          put: content-store-terraform-outputs
          params:
            file: content-store-terraform-outputs/content-store.json
      - try:
          put: frontend-terraform-outputs
          params:
            file: frontend-terraform-outputs/frontend.json
      - try:
          put: publisher-terraform-outputs
          params:
            file: publisher-terraform-outputs/publisher.json
      - try:
          put: publishing-api-terraform-outputs
          params:
            file: publishing-api-terraform-outputs/publishing-api.json
      - try:
          put: signon-terraform-outputs
          params:
            file: signon-terraform-outputs/signon.json
      - try:
          put: smokey-terraform-outputs
          params:
            file: smokey-terraform-outputs/smokey.json
      - try:
          put: static-terraform-outputs
          params:
            file: static-terraform-outputs/static.json
      - try:
          put: router-api-terraform-outputs
          params:
            file: router-api-terraform-outputs/router-api.json
      - try:
          put: router-terraform-outputs
          params:
            file: router-terraform-outputs/router.json
      - try:
          put: authenticating-proxy-terraform-outputs
          params:
            file: authenticating-proxy-terraform-outputs/authenticating-proxy.json
    on_failure: &notify-slack-failure
      put: deploy-slack-channel
      params:
        channel: "#govuk-deploy-alerts" # TODO: Alert owner Slack channels in future, i.e. ((search_team_slack))
        username: '((govuk_environment))-((workspace)) deploy-apps'
        icon_emoji: ':concourse:'
        silent: true
        text: |
          :red_circle: Failed build: http://cd.gds-reliability.engineering/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME

  - name: all-smoke-tests
    plan:
    - in_parallel:
      - get: every-10-minutes-in-daytime
        trigger: true
      - &get-smokey-govuk-infrastructure
        get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - <<: *bootstrap-trigger
        passed:
        - deploy-frontend
        - deploy-publisher
        - deploy-signon
        - deploy-authenticating-proxy
      - &get-smokey-app-tf-outputs
        get: app-terraform-outputs
        resource: smokey-terraform-outputs
        passed: [deploy-smokey]
    - &get-smokey-task-definition
      task: fetch-smokey-task-definition
      file: govuk-infrastructure/concourse/tasks/fetch-task-definition.yml
      params:
        APPLICATION: smokey-((workspace))
    - &run-smoke-test
      task: run-smoke-tests
      file: govuk-infrastructure/concourse/tasks/run-task.yml
      attempts: 3
      params: &smoke-tests-params
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        APPLICATION: smokey
        VARIANT: default
        LOG_TO_SPLUNK: false
        COMMAND: bundle exec cucumber --profile test --strict-undefined -t @replatforming -t \"not @notreplatforming and not @not((govuk_environment))\"
    on_failure:
      <<: *notify-slack-failure

  - name: autogenerate-secrets
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: secret_key_bases
        resource: secret_key_bases-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [run-terraform]
    - task: secret_key_base
      file: govuk-infrastructure/concourse/tasks/autogenerate-secret-key-base.yml
      input_mapping:
        terraform-outputs: secret_key_bases
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
      vars:
        concourse_deployer_role_arn: ((concourse_deployer_role_arn))
        concourse_ecr_role_arn: ((concourse_ecr_role_arn))
        ecr_registry_id: ((ecr_registry_id))
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-frontend
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: frontend-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [deploy-signon,deploy-static,deploy-content-store]
      - get: frontend-image
        trigger: true
      - try:
          get: frontend-deploy-event-trigger
          trigger: true
      - try:
          get: draft-frontend-deploy-event-trigger
          trigger: true
    - in_parallel:
      - &bootstrap-secrets
        task: bootstrap-secrets
        file: govuk-infrastructure/concourse/tasks/bootstrap-app-secrets.yml
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: frontend
          VARIANT: live
        vars:
          concourse_deployer_role_arn: ((concourse_deployer_role_arn))
          concourse_ecr_role_arn: ((concourse_ecr_role_arn))
          ecr_registry_id: ((ecr_registry_id))
      - task: push-dir-to-s3
        file: govuk-infrastructure/concourse/tasks/push-dir-to-s3.yml
        input_mapping:
          src: frontend-image
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          SOURCE_PATH: src/rootfs/app/public/assets/frontend
          S3_BUCKET_PATH_PATTERN: s3://govuk-((govuk_environment))-%s-frontends-rails-assets/assets/frontend/ # %s will be replaced by interpolated workspace in push-dir-to-s3.yml
          WORKSPACE: ((workspace))
      - task: update-draft-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: frontend-image
        output_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: frontend
          VARIANT: draft
      - task: update-live-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: frontend-image
        output_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: frontend
          VARIANT: live
    - in_parallel:
      - task: update-draft-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          ECS_SERVICE: draft-frontend
          WORKSPACE: ((workspace))
      - task: update-live-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          ECS_SERVICE: frontend
          WORKSPACE: ((workspace))
    - in_parallel:
      - &await-secretsmanager-creds
        task: await-creds-in-secrets-manager
        file: govuk-infrastructure/concourse/tasks/await-creds-in-secretsmanager.yml
        attempts: 3
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: frontend
          VARIANT: live
        vars:
          concourse_deployer_role_arn: ((concourse_deployer_role_arn))
          concourse_ecr_role_arn: ((concourse_ecr_role_arn))
          ecr_registry_id: ((ecr_registry_id))
      - <<: *await-secretsmanager-creds
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: frontend
          VARIANT: draft
    - in_parallel:
      - &await-deploy-complete
        task: await-deploy-complete-live
        file: govuk-infrastructure/concourse/tasks/await-deploy-complete.yml
        attempts: 5
        timeout: 5m
        params: &await-deploy-complete-params
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          ECS_SERVICE: frontend
          WORKSPACE: ((workspace))
      - <<: *await-deploy-complete
        task: await-deploy-complete-draft
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: draft-frontend
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: smoke-test-frontend
    plan:
    - in_parallel:
        - <<: *get-smokey-govuk-infrastructure
          passed: [deploy-frontend]
        - get: frontend-terraform-outputs
          passed: [deploy-frontend]
          trigger: true
        - get: frontend-image
          passed: [deploy-frontend]
          trigger: true
        - <<: *get-smokey-app-tf-outputs
    - <<: *get-smokey-task-definition
    - <<: *run-smoke-test
      params:
        <<: *smoke-tests-params
        COMMAND: bundle exec cucumber --profile test --strict-undefined -t @app-frontend -t @replatforming -t \"not @notreplatforming\"
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-publisher
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: publisher-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [deploy-signon,deploy-frontend,deploy-publishing-api]
      - get: publisher-image
        trigger: true
      - try:
          get: publisher-deploy-event-trigger
          trigger: true
    - in_parallel:
      - <<: *bootstrap-secrets
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publisher
          VARIANT: web
      - task: push-dir-to-s3
        file: govuk-infrastructure/concourse/tasks/push-dir-to-s3.yml
        input_mapping:
          src: publisher-image
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          SOURCE_PATH: src/rootfs/app/public/assets/publisher
          S3_BUCKET_PATH_PATTERN: s3://govuk-((govuk_environment))-%s-backends-rails-assets/assets/publisher/ # %s will be replaced by interpolated workspace in push-dir-to-s3.yml
          WORKSPACE: ((workspace))
      - task: update-web-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: publisher-image
        output_mapping:
          task-definition-arn: web-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publisher
          VARIANT: web
          GOVUK_ENVIRONMENT: ((govuk_environment))
      - task: update-worker-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: publisher-image
        output_mapping:
          task-definition-arn: worker-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publisher
          VARIANT: worker
          GOVUK_ENVIRONMENT: ((govuk_environment))
    - in_parallel:
      - <<: *await-secretsmanager-creds
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publisher
          VARIANT: web
      - <<: *await-secretsmanager-creds
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publisher
          VARIANT: worker
    - task: run-db-migrations
      file: govuk-infrastructure/concourse/tasks/run-task.yml
      input_mapping:
        task-definition-arn: web-task-definition-arn
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        APPLICATION: publisher
        COMMAND: "bundle exec rails db:migrate"
        VARIANT: web
        DISABLE: ((skip_db_migrations))
    - in_parallel:
      - task: update-web-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: web-task-definition-arn
        params:
          ECS_SERVICE: publisher-web
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
      - task: update-worker-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: worker-task-definition-arn
        params:
          ECS_SERVICE: publisher-worker
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
    - in_parallel:
      - <<: *await-deploy-complete
        task: await-deploy-complete-web
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: publisher-web
      - <<: *await-deploy-complete
        task: await-deploy-complete-worker
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: publisher-worker
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: smoke-test-publisher
    plan:
    - in_parallel:
        - <<: *get-smokey-govuk-infrastructure
          passed: [deploy-publisher]
        - get: publisher-terraform-outputs
          passed: [deploy-publisher]
          trigger: true
        - get: publisher-image
          passed: [deploy-publisher]
          trigger: true
        - <<: *get-smokey-app-tf-outputs
    - <<: *get-smokey-task-definition
    - <<: *run-smoke-test
      params:
        <<: *smoke-tests-params
        COMMAND: bundle exec cucumber --profile test --strict-undefined -t @app-publisher -t @replatforming -t \"not @notreplatforming and not @not((govuk_environment))\"
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-content-schemas
    plan:
    - in_parallel:
      - <<: *bootstrap-trigger
        passed: [run-terraform]
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
      - get: content-schemas
        # TODO: Set to false to prevent continuous deployment
        trigger: true
    - task: push-content-schemas-to-s3
      file: govuk-infrastructure/concourse/tasks/push-dir-to-s3.yml
      input_mapping:
        src: content-schemas
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        SOURCE_PATH: src
        S3_BUCKET_PATH_PATTERN: s3://govuk-((govuk_environment))-%s-content-schemas/
        WORKSPACE: ((workspace))

  - name: deploy-publishing-api
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: publishing-api-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [deploy-signon,deploy-content-schemas,deploy-content-store]
      - get: content-schemas
        trigger: true
        passed: [deploy-content-schemas]
        params:
         skip_download: true
      - get: publishing-api-image
        trigger: true
        params:
         skip_download: true
      - try:
          get: publishing-api-deploy-event-trigger
          trigger: true
    - in_parallel:
      - <<: *bootstrap-secrets
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publishing-api
          VARIANT: web
      - task: update-web-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: publishing-api-image
        output_mapping:
          task-definition-arn: web-task-definition-arn
        params:
          APPLICATION: publishing-api
          VARIANT: web
          GOVUK_ENVIRONMENT: ((govuk_environment))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
      - task: update-worker-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: publishing-api-image
        output_mapping:
          task-definition-arn: worker-task-definition-arn
        params:
          APPLICATION: publishing-api
          VARIANT: worker
          GOVUK_ENVIRONMENT: ((govuk_environment))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
    - in_parallel:
      - <<: *await-secretsmanager-creds
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publishing-api
          VARIANT: web
      - <<: *await-secretsmanager-creds
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: publishing-api
          VARIANT: worker
    - task: run-db-migrations
      file: govuk-infrastructure/concourse/tasks/run-task.yml
      input_mapping:
        task-definition-arn: web-task-definition-arn
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        APPLICATION: publishing-api
        COMMAND: "bundle exec rails db:migrate"
        VARIANT: web
        DISABLE: ((skip_db_migrations))
    - in_parallel:
      - task: update-web-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        params:
          ECS_SERVICE: publishing-api-web
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        input_mapping:
          task-definition-arn: web-task-definition-arn
      - task: update-worker-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        params:
          ECS_SERVICE: publishing-api-worker
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        input_mapping:
          task-definition-arn: worker-task-definition-arn
    - in_parallel:
      - <<: *await-deploy-complete
        task: await-deploy-complete-web
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: publishing-api-web
      - <<: *await-deploy-complete
        task: await-deploy-complete-worker
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: publishing-api-worker
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-content-store
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: content-store-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [deploy-signon,deploy-router-api]
      - get: content-store-image
        trigger: true
        params:
         skip_download: true
      - try:
          get: content-store-deploy-event-trigger
          trigger: true
      - try:
          get: draft-content-store-deploy-event-trigger
          trigger: true
    - in_parallel:
      - <<: *bootstrap-secrets
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: content-store
          VARIANT: draft
      - <<: *bootstrap-secrets
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: content-store
          VARIANT: live
      - task: update-draft-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: content-store-image
        output_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          APPLICATION: content-store
          VARIANT: draft
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
      - task: update-live-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: content-store-image
        output_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          APPLICATION: content-store
          VARIANT: live
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
    - in_parallel:
      - <<: *await-secretsmanager-creds
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: content-store
          VARIANT: live
      - task: await-creds-in-secrets-manager
        file: govuk-infrastructure/concourse/tasks/await-creds-in-secretsmanager.yml
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: content-store
          VARIANT: draft
        vars:
          concourse_deployer_role_arn: ((concourse_deployer_role_arn))
          concourse_ecr_role_arn: ((concourse_ecr_role_arn))
          ecr_registry_id: ((ecr_registry_id))
    - in_parallel:
      - task: update-live-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ECS_SERVICE: content-store
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
      - task: update-draft-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ECS_SERVICE: draft-content-store
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
    - in_parallel:
      - <<: *await-deploy-complete
        task: await-deploy-complete-live
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: content-store
      - <<: *await-deploy-complete
        task: await-deploy-complete-draft
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: draft-content-store
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-router
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: router-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: router-image
        trigger: true
        params:
         skip_download: true
      - try:
          get: router-deploy-event-trigger
          trigger: true
    - in_parallel:
      - task: update-draft-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: router-image
        output_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          APPLICATION: router
          VARIANT: draft
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
      - task: update-live-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: router-image
        output_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          APPLICATION: router
          VARIANT: live
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
    - in_parallel:
      - task: update-draft-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ECS_SERVICE: draft-router
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
      - task: update-live-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ECS_SERVICE: router
          WORKSPACE: ((workspace))
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
    - in_parallel:
      - <<: *await-deploy-complete
        task: await-deploy-complete-draft
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: draft-router
      - <<: *await-deploy-complete
        task: await-deploy-complete-live
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: router
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-router-api
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        passed:
        trigger: true
      - get: app-terraform-outputs
        resource: router-api-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [deploy-signon]
      - get: router-api-image
        trigger: true
        params:
         skip_download: true
      - try:
          get: router-api-deploy-event-trigger
          trigger: true
      - try:
          get: draft-router-api-deploy-event-trigger
          trigger: true
    - in_parallel:
      - <<: *await-secretsmanager-creds
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: router-api
          VARIANT: live
      - task: update-draft-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: router-api-image
        output_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: router-api
          VARIANT: draft
      - task: update-live-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: router-api-image
        output_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: router-api
          VARIANT: live
    - in_parallel:
      - task: update-draft-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          ECS_SERVICE: draft-router-api
          WORKSPACE: ((workspace))
      - task: update-live-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          ECS_SERVICE: router-api
          WORKSPACE: ((workspace))
    - in_parallel:
      - <<: *await-deploy-complete
        task: await-deploy-complete-draft
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: draft-router-api
      - <<: *await-deploy-complete
        task: await-deploy-complete-live
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: router-api
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-signon
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: signon-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [run-terraform,autogenerate-secrets]
      - get: signon-image
        trigger: true
    - in_parallel:
      - task: push-dir-to-s3
        file: govuk-infrastructure/concourse/tasks/push-dir-to-s3.yml
        input_mapping:
          src: signon-image
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          SOURCE_PATH: src/rootfs/app/public/assets/signon
          S3_BUCKET_PATH_PATTERN: s3://govuk-((govuk_environment))-%s-backends-rails-assets/assets/signon/ # %s will be replaced by interpolated workspace in push-dir-to-s3.yml
          WORKSPACE: ((workspace))
      - task: update-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: signon
          GOVUK_ENVIRONMENT: ((govuk_environment))
          VARIANT: web
        input_mapping:
          app-image: signon-image
        output_mapping:
          task-definition-arn: task-definition-arn
    # TODO: Replace apiusers bootstrap task with api
    - task: make-bootstrap-command
      file: govuk-infrastructure/concourse/tasks/make-signon-bootstrap-command.yml
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        GOVUK_ENVIRONMENT: ((govuk_environment))
        WORKSPACE: ((workspace))
    - task: create-signon-resources
      file: govuk-infrastructure/concourse/tasks/run-task.yml
      input_mapping:
        task-definition-arn: task-definition-arn
        run-task-command: run-task-command
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        APPLICATION: signon
        VARIANT: web
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      input_mapping:
        task-definition-arn: task-definition-arn
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        ECS_SERVICE: signon
        GOVUK_ENVIRONMENT: ((govuk_environment))
        WORKSPACE: ((workspace))
    - <<: *await-deploy-complete
      task: await-deploy-complete
      params:
        <<: *await-deploy-complete-params
        ECS_SERVICE: signon
    # todo: add bootstrap-oauth-api-users
    - task: bootstrap-oauth-apps
      file: govuk-infrastructure/concourse/tasks/bootstrap-oauth-apps.yml
      input_mapping:
        app-terraform-outputs: app-terraform-outputs
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        APPLICATION: signon
        VARIANT: web
      vars:
        concourse_deployer_role_arn: ((concourse_deployer_role_arn))
        concourse_ecr_role_arn: ((concourse_ecr_role_arn))
        ecr_registry_id: ((ecr_registry_id))
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: smoke-test-signon
    plan:
    - in_parallel:
        - <<: *get-smokey-govuk-infrastructure
          passed: [deploy-signon]
        - get: signon-terraform-outputs
          passed: [deploy-signon]
          trigger: true
        - <<: *bootstrap-trigger
          passed: [deploy-signon]
        - get: signon-image
          passed: [deploy-signon]
          trigger: true
        - <<: *get-smokey-app-tf-outputs
    - <<: *get-smokey-task-definition
    - <<: *run-smoke-test
      params:
        <<: *smoke-tests-params
        COMMAND: bundle exec cucumber --profile test --strict-undefined -t @app-signon -t @replatforming -t \"not @notreplatforming\"
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-smokey
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: smokey-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - get: smokey-image
        trigger: true
        params:
         skip_download: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      input_mapping:
        app-image: smokey-image
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        APPLICATION: smokey
        GOVUK_ENVIRONMENT: ((govuk_environment))
        VARIANT: default
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-static
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: static-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [run-terraform]
      - get: static-image
        trigger: true
      - try:
          get: static-deploy-event-trigger
          trigger: true
    - in_parallel:
      - task: push-dir-to-s3
        file: govuk-infrastructure/concourse/tasks/push-dir-to-s3.yml
        input_mapping:
          src: static-image
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          SOURCE_PATH: src/rootfs/app/public/assets/static
          S3_BUCKET_PATH_PATTERN: s3://govuk-((govuk_environment))-%s-frontends-rails-assets/assets/static/ # %s will be replaced by interpolated workspace in push-dir-to-s3.yml
          WORKSPACE: ((workspace))
      - task: update-draft-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: static-image
        output_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: static
          VARIANT: draft
      - task: update-live-task-definition
        file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
        input_mapping:
          app-image: static-image
        output_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          APPLICATION: static
          VARIANT: live
    - in_parallel:
      - task: update-draft-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: draft-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          ECS_SERVICE: draft-static
          WORKSPACE: ((workspace))
      - task: update-live-ecs-service
        file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
        input_mapping:
          task-definition-arn: live-task-definition-arn
        params:
          ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
          ECS_SERVICE: static
          WORKSPACE: ((workspace))
    - in_parallel:
      - <<: *await-deploy-complete
        task: await-deploy-complete-live
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: static
      - <<: *await-deploy-complete
        task: await-deploy-complete-draft
        params:
          <<: *await-deploy-complete-params
          ECS_SERVICE: draft-static
    serial: true
    on_failure:
      <<: *notify-slack-failure

  - name: deploy-authenticating-proxy
    plan:
    - in_parallel:
      - get: govuk-infrastructure
        resource: govuk-infrastructure-concourse-tasks
        trigger: true
      - get: app-terraform-outputs
        resource: authenticating-proxy-terraform-outputs
        passed:
        - run-terraform
        trigger: true
      - <<: *bootstrap-trigger
        passed: [deploy-signon]
      - get: authenticating-proxy-image
        trigger: true
        params:
         skip_download: true
      - try:
          get: authenticating-proxy-deploy-event-trigger
          trigger: true
    - task: update-task-definition
      file: govuk-infrastructure/concourse/tasks/update-task-definition.yml
      input_mapping:
        app-image: authenticating-proxy-image
      output_mapping:
        task-definition-arn: task-definition-arn
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        APPLICATION: authenticating-proxy
        VARIANT: web
    - task: update-ecs-service
      file: govuk-infrastructure/concourse/tasks/update-ecs-service.yml
      input_mapping:
        task-definition-arn: task-definition-arn
      params:
        ASSUME_ROLE_ARN: ((concourse_deployer_role_arn))
        ECS_SERVICE: authenticating-proxy
        WORKSPACE: ((workspace))
    - <<: *await-deploy-complete
      task: await-deploy-complete-live
      params:
        <<: *await-deploy-complete-params
        ECS_SERVICE: authenticating-proxy
    serial: true
    on_failure:
      <<: *notify-slack-failure
